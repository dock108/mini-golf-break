echo "ğŸ” Running pre-commit quality checks..."
echo "â„¹ï¸  Matching CI pipeline validation to prevent surprises"

# Stage 1: Code Quality (Linting + Formatting)
echo ""
echo "ğŸ“ Stage 1: Code Quality Checks"
echo "==============================================="

# Check formatting BEFORE fixing (match CI behavior)
echo "ğŸ” Checking code formatting..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting issues found!"
  echo "ğŸ’¡ Auto-fixing formatting issues..."
  npx lint-staged
  echo "âœ… Formatting fixed. Please review and re-commit."
  exit 1
fi

# Run ESLint on all files (match CI behavior)
echo "ğŸ” Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint errors found!"
  echo "ğŸ’¡ Try running: npm run lint:fix"
  exit 1
fi

# Stage 2: Security Audits (Match CI levels exactly)
echo ""
echo "ğŸ”’ Stage 2: Security Audits"
echo "==============================================="

echo "ğŸ” Running moderate-level security audit..."
npm audit --audit-level moderate
MODERATE_EXIT_CODE=$?

echo "ğŸ” Running high-level production security audit..."
npm audit --audit-level high --production
HIGH_EXIT_CODE=$?

if [ $MODERATE_EXIT_CODE -ne 0 ] || [ $HIGH_EXIT_CODE -ne 0 ]; then
  echo "âŒ Security vulnerabilities found!"
  echo "ğŸ’¡ Try running: npm audit fix"
  exit 1
else
  echo "âœ… No security vulnerabilities found"
fi

# Stage 3: Build Validation (Match CI behavior)
echo ""
echo "ğŸ”§ Stage 3: Build Validation"
echo "==============================================="

echo "ğŸ” Building application (development)..."
NODE_ENV=development npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Development build failed!"
  exit 1
fi

echo "ğŸ” Building application (production)..."
NODE_ENV=production npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Production build failed!"
  exit 1
fi

# Stage 4: Test Suite (Smart execution for performance)
echo ""
echo "ğŸ§ª Stage 4: Test Validation"
echo "==============================================="

# Check if any test files have been modified
MODIFIED_TEST_FILES=$(git diff --cached --name-only | grep -E '\.(test|spec)\.js$' | wc -l)
MODIFIED_SRC_FILES=$(git diff --cached --name-only | grep -E '^src/.*\.js$' | wc -l)

if [ "$MODIFIED_TEST_FILES" -gt "0" ] || [ "$MODIFIED_SRC_FILES" -gt "5" ]; then
  echo "ğŸ§ª Running unit tests (significant changes detected)..."
  npm run test:unit -- --watchAll=false --passWithNoTests
  if [ $? -ne 0 ]; then
    echo "âŒ Unit tests failed!"
    echo "ğŸ’¡ Fix failing tests before committing"
    exit 1
  fi
  
  echo "ğŸ§ª Running integration tests..."
  npm run test:integration -- --watchAll=false --passWithNoTests
  if [ $? -ne 0 ]; then
    echo "âš ï¸  Integration tests failed, but allowing commit with warning"
    echo "ğŸ’¡ Please fix integration tests in a follow-up commit"
  fi
else
  echo "ğŸ§ª Skipping tests (minimal changes detected)"
  echo "ğŸ’¡ Run 'npm test' manually if needed"
fi

# Stage 5: Performance Check
echo ""
echo "ğŸ“Š Stage 5: Performance Validation"
echo "==============================================="

echo "ğŸ“ Checking bundle size..."
MAIN_BUNDLE_SIZE=$(du -k dist/main.*.js 2>/dev/null | cut -f1 | head -1)
if [ -n "$MAIN_BUNDLE_SIZE" ] && [ "$MAIN_BUNDLE_SIZE" -gt "1024" ]; then
  echo "âš ï¸  Warning: Main bundle size (${MAIN_BUNDLE_SIZE}KB) exceeds 1MB threshold"
  echo "ğŸ’¡ Consider code splitting or optimization"
else
  echo "âœ… Bundle size within acceptable limits"
fi

# Success summary
echo ""
echo "ğŸ‰ Pre-commit Validation Complete!"
echo "==============================================="
echo "âœ… Code formatting and linting passed"
echo "âœ… Security audits passed"
echo "âœ… Build validation passed"
echo "âœ… Test validation completed"
echo "âœ… Performance check completed"
echo ""
echo "ğŸš€ Ready to commit! Changes match CI pipeline requirements."