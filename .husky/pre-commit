echo "ğŸ” Running pre-commit quality checks..."
echo "â„¹ï¸  Matching CI pipeline validation to prevent surprises"

# Stage 1: Code Quality (Linting + Formatting)
echo ""
echo "ğŸ“ Stage 1: Code Quality Checks"
echo "==============================================="

# Check formatting BEFORE fixing (match CI behavior)
echo "ğŸ” Checking code formatting..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting issues found!"
  echo "ğŸ’¡ Auto-fixing formatting issues..."
  npx lint-staged
  echo "âœ… Formatting fixed. Please review and re-commit."
  exit 1
fi

# Run ESLint on all files (match CI behavior)
echo "ğŸ” Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint errors found!"
  echo "ğŸ’¡ Try running: npm run lint:fix"
  exit 1
fi

# Stage 2: Security Audits (Match CI levels exactly)
echo ""
echo "ğŸ”’ Stage 2: Security Audits"
echo "==============================================="

echo "ğŸ” Running moderate-level security audit..."
npm audit --audit-level moderate
MODERATE_EXIT_CODE=$?

echo "ğŸ” Running high-level production security audit..."
npm audit --audit-level high --production
HIGH_EXIT_CODE=$?

if [ $MODERATE_EXIT_CODE -ne 0 ] || [ $HIGH_EXIT_CODE -ne 0 ]; then
  echo "âŒ Security vulnerabilities found!"
  echo "ğŸ’¡ Try running: npm audit fix"
  exit 1
else
  echo "âœ… No security vulnerabilities found"
fi

# Stage 3: Build Validation (Match CI behavior)
echo ""
echo "ğŸ”§ Stage 3: Build Validation"
echo "==============================================="

echo "ğŸ” Building application (development)..."
NODE_ENV=development npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Development build failed!"
  exit 1
fi

echo "ğŸ” Building application (production)..."
NODE_ENV=production npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Production build failed!"
  exit 1
fi

# Stage 4: Test Suite (Always run to match CI exactly)
echo ""
echo "ğŸ§ª Stage 4: Test Validation"
echo "==============================================="

echo "ğŸ§ª Running unit tests with coverage..."
npm run test:unit -- --coverage --watchAll=false
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo "âŒ Unit tests failed!"
  echo ""
  echo "âš ï¸  Possible reasons for failure:"
  echo "  1. Test failures - Fix failing tests before committing"
  echo "  2. Coverage below 80% threshold - Add more tests to improve coverage"
  echo ""
  echo "ğŸ’¡ Run 'npm run test:coverage:unit' to see detailed coverage report"
  exit 1
fi

echo "âœ… Unit tests passed with sufficient coverage"

echo "ğŸ§ª Running integration tests..."
npm run test:integration -- --watchAll=false
if [ $? -ne 0 ]; then
  echo "âŒ Integration tests failed!"
  echo "ğŸ’¡ Fix failing integration tests before committing"
  exit 1
fi

# Stage 5: Performance Check
echo ""
echo "ğŸ“Š Stage 5: Performance Validation"
echo "==============================================="

echo "ğŸ“ Checking bundle size..."
MAIN_BUNDLE_SIZE=$(du -k dist/main.*.js 2>/dev/null | cut -f1 | head -1)
if [ -n "$MAIN_BUNDLE_SIZE" ] && [ "$MAIN_BUNDLE_SIZE" -gt "1024" ]; then
  echo "âš ï¸  Warning: Main bundle size (${MAIN_BUNDLE_SIZE}KB) exceeds 1MB threshold"
  echo "ğŸ’¡ Consider code splitting or optimization"
else
  echo "âœ… Bundle size within acceptable limits"
fi

# Success summary
echo ""
echo "ğŸ‰ Pre-commit Validation Complete!"
echo "==============================================="
echo "âœ… Code formatting and linting passed"
echo "âœ… Security audits passed"
echo "âœ… Build validation passed"
echo "âœ… Test validation completed"
echo "âœ… Performance check completed"
echo ""
echo "ğŸš€ Ready to commit! Changes match CI pipeline requirements."